name: JFrog DevSecOps Pipeline
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ secrets.JF_URL }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      # Ensure these match your actual repository names in JFrog
      MAVEN_REPO: "maven-virt"
      DOCKER_REPO: "docker-local"
      SERVER_ID: "jfrog-instance"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # This ensures a stable Maven version is used
          cache: 'maven'

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Authenticate and Configure Maven
        run: |
          jf c add $SERVER_ID --url=$JF_URL --access-token=$JF_ACCESS_TOKEN --overwrite
          jf mvn-config --server-id-resolve $SERVER_ID --server-id-deploy $SERVER_ID \
            --repo-resolve-releases $MAVEN_REPO --repo-resolve-snapshots $MAVEN_REPO \
            --repo-deploy-releases maven-local --repo-deploy-snapshots maven-local

      - name: Build, Test, and Deploy JAR
        run: |
          # Captures build metadata while compiling and testing (Requirement 21, 22, 23)
          jf mvn clean deploy -U

      - name: Build and Push Docker Image
        run: |
          # 1. Login to JFrog Docker Registry (Requirement 25)
          # Replace <your-jfrog-url> with your instance name, e.g., myjfrog.jfrog.io
          echo ${{ secrets.JF_ACCESS_TOKEN }} | docker login <your-jfrog-url> -u <your-email> --password-stdin
          
          # 2. Build and Tag (Requirement 24)
          docker build . -t <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}
          
          # 3. Push to Artifactory
          docker push <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}

      - name: Scan Docker Image (Bonus)
        run: |
          # Triggers JFrog Xray to scan the image for vulnerabilities (Requirement 35)
          jf docker scan <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}

      - name: Publish Build Info
        run: |
          # Finalizes traceability and auditability (Requirement 27, 28)
          jf rt build-publish $SERVER_ID ${{ github.run_number }}
