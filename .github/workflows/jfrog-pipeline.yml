name: JFrog DevSecOps Pipeline
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ secrets.JF_URL }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      MAVEN_REPO: "maven-virt"
      DOCKER_REPO: "docker-local"
      SERVER_ID: "jfrog-instance"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Authenticate JFrog
        run: |
          jf c add $SERVER_ID --url=$JF_URL --access-token=$JF_ACCESS_TOKEN --overwrite

      - name: Build and Deploy (Direct Method)
        run: |
          # We bypass the automated 'jf mvn' wrapper to avoid the null pointer error
          # We use standard mvn but point it to Artifactory via the CLI
          jf mvn clean deploy -U --server-id-res $SERVER_ID --server-id-deploy $SERVER_ID

      - name: Build and Push Docker Image
        run: |
          # Authenticate Docker (Requirement 25)
          # Replace <your-jfrog-url> with your instance domain (e.g., yourname.jfrog.io)
          echo ${{ secrets.JF_ACCESS_TOKEN }} | docker login <your-jfrog-url> -u <your-email> --password-stdin
          
          # Build and Tag (Requirement 24)
          docker build . -t <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}
          
          # Push image
          docker push <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}

      - name: Publish Build Info
        run: |
          # Capture the full audit trail (Requirement 27, 28)
          jf rt build-publish $SERVER_ID ${{ github.run_number }}
