name: JFrog DevSecOps Pipeline
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ secrets.JF_URL }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      MAVEN_REPO: "maven-virt"
      DOCKER_REPO: "docker-local"
      SERVER_ID: "jfrog-instance"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # This step fixes the "prerequisitesCheckers is null" error by using a stable Maven version
      - name: Set up JDK 17 and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Authenticate and Configure Maven
        run: |
          jf c add $SERVER_ID --url=$JF_URL --access-token=$JF_ACCESS_TOKEN --overwrite
          jf mvn-config --server-id-resolve $SERVER_ID --server-id-deploy $SERVER_ID \
            --repo-resolve-releases $MAVEN_REPO --repo-resolve-snapshots $MAVEN_REPO \
            --repo-deploy-releases maven-local --repo-deploy-snapshots maven-local

      - name: Build, Test, and Deploy JAR
        run: |
          # This compiles the code and uploads the JAR to Artifactory (Requirement 22, 23)
          jf mvn clean deploy -U

      - name: Build and Push Docker Image
        run: |
          # Replace <your-jfrog-url> with your instance domain (e.g., acme.jfrog.io)
          echo ${{ secrets.JF_ACCESS_TOKEN }} | docker login <your-jfrog-url> -u <your-email> --password-stdin
          
          # Build and Tag the image (Requirement 24)
          docker build . -t <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}
          
          # Push the image to the secure registry
          docker push <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}

      - name: Publish Build Info
        run: |
          # This provides the traceability and auditability requested (Requirement 27, 28)
          jf rt build-publish $SERVER_ID ${{ github.run_number }}
