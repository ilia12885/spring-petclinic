name: JFrog DevSecOps Pipeline
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JF_URL: ${{ secrets.JF_URL }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      MAVEN_REPO: "maven-virt"
      DOCKER_REPO: "docker-local"
      SERVER_ID: "jfrog-instance"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Authenticate and Configure Project
        run: |
          # 1. Register the server credentials
          jf c add $SERVER_ID --url=$JF_URL --access-token=$JF_ACCESS_TOKEN --overwrite
          
          # 2. CREATE THE CONFIG FILE (This fixes the 'no config file found' error)
          jf mvn-config --server-id-resolve $SERVER_ID \
                        --server-id-deploy $SERVER_ID \
                        --repo-resolve-releases $MAVEN_REPO \
                        --repo-resolve-snapshots $MAVEN_REPO \
                        --repo-deploy-releases maven-local \
                        --repo-deploy-snapshots maven-local

      - name: Build, Test, and Deploy JAR
        run: |
          # Now the config file exists, so 'jf mvn' will work perfectly
          jf mvn clean deploy -U

      - name: Build and Push Docker Image
        run: |
          # Replace <your-jfrog-url> with your instance domain (e.g., yourname.jfrog.io)
          echo ${{ secrets.JF_ACCESS_TOKEN }} | docker login <your-jfrog-url> -u <your-email> --password-stdin
          
          # Build and Tag (Requirement 24)
          docker build . -t <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}
          
          # Push to Artifactory
          docker push <your-jfrog-url>/$DOCKER_REPO/spring-petclinic:${{ github.run_number }}

      - name: Publish Build Info
        run: |
          # Finalize the 'Software Bill of Materials' for full traceability (Requirement 6, 28)
          jf rt build-publish $SERVER_ID ${{ github.run_number }}
